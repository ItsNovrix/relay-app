import {
  Devvit,
  Context,
  FormOnSubmitEvent,
  MenuItemOnPressEvent,
  WikiPage,
  WikiPagePermissionLevel,
} from "@devvit/public-api";
import { Paragraph } from "@devvit/shared-types/richtext/types.js";
import {
  isModerator,
  replacePlaceholders,
  getRecommendedPlaceholdersFromModAction,
  assembleRemovalReason,
  submitPostReply,
  ignoreReportsByPostId,
  setLockByPostId,
  isBanned,
} from "devvit-helpers";

// ==========================================================
// 1. DEVVIT CONFIGURATION
// ==========================================================

Devvit.configure({
  redditAPI: true,
  redis: true,
  modLog: false,
  http: true,
});

// ==========================================================
// 2. SCHEDULED POSTS JOB
// ==========================================================

Devvit.addSchedulerJob({
  name: 'scheduled_post_job',
  onRun: async (event, context) => {
    const { templateNumber } = event.data!;
    const subreddit = await context.reddit.getCurrentSubreddit();
    
    const title = await context.settings.get(`postTemplate${templateNumber}title`) as string;
    const body = await context.settings.get(`postTemplate${templateNumber}body`) as string;
    const sticky = await context.settings.get(`postTemplate${templateNumber}Sticky`) as boolean;
    const lock = await context.settings.get(`postTemplate${templateNumber}Lock`) as boolean;

    if (!title) return;

    const post = await context.reddit.submitPost({
      subredditName: subreddit.name,
      title: title,
      text: body,
    });

    await post.distinguish(true);
    if (sticky) await post.sticky();
    if (lock) await post.lock();

    console.log(`Scheduled Template ${templateNumber} posted successfully!`);

    const repeat = await context.settings.get(
      `postTemplate${templateNumber}Repeat`
    ) as boolean;

    if (!repeat && event.job?.id) {
      await context.scheduler.cancelJob(event.job.id);
    }
  },
});

// ==========================================================
// 3. SETTINGS & CONFIG
// ==========================================================

Devvit.addSettings([
  
  // --- NOTIFICATION SETTINGS ---

    {
    type: "group",
    label: "Relay App Notifications",
    fields: [
      {
        type: "boolean",
        name: "notify_on_posts",
        label: "Notify on Post Replies",
        helpText: `Choose this if you'd like to receive Modmail notifications when users reply to posts or comments made via Relay App.`,
        defaultValue: false,
      },
      {
        type: "boolean",
        name: "notify_on_comments",
        label: "Notify on Comment Replies",
        helpText: `Choose this if you'd like to receive Modmail notifications when users reply to comments made via Relay App.`,
        defaultValue: false,
      },
      {
        type: "boolean",
        name: "notify_ignore_mods",
        label: "Ignore replies from moderators",
        helpText: `Choose this if you'd like to ignore replies from moderators when sending notifications.`,
        defaultValue: true,
      },
            {
        type: "string",
        name: "notify_extra_users",
        label: "Also notify for these specified Users (comma-separated, not case-sensitive)",
        helpText: `Optionally specify additional usernames to be notified of replies (e.g., AutoModerator). Omit the leading /u/.`,
      },
    ],
  },

  // --- PUBLISH/EDIT NOTIFICATION SETTINGS ---

  {
    type: "group",
    label: "Publish/Edit Notifications",
    fields: [
        {
        type: "boolean",
        name: "sendModmail",
        label: "Send to Modmail?",
        helpText: `Choose this if you'd like to receive a copy of each Relay App publish and edit in Modmail.`,
        defaultValue: false,
      },
      {
        type: "boolean",
        name: "sendDiscord",
        label: "Send to Discord?",
        helpText: `Choose this if you'd like to receive notifications of each Relay App publish and edit on your Discord server via webhook. Very long posts may be truncated by Discord.`,
        defaultValue: false,
      },
      {
        type: "string",
        name: "webhookEditor",
        label: "Webhook URL",
        helpText: `Paste your Discord webhook URL (Server Settings → Integrations → Webhooks).`,
      },
      {
        type: "string",
        name: "discordRole",
        label: "Role ID to ping",
        helpText: `Optional: paste the role ID to @mention (enable "Mentionable" for that role in Discord).`,
      },
    ],
  },
  
  // --- AUTO-FLAIR SETTINGS ---

  {
    type: "group",
    label: "Auto-flair settings",
    fields: [
      {
        name: "setFlairAfterPosting",
        type: "boolean",
        label: `Enable auto-flair after posting?`,
        helpText: `Automatically set the post flair after a Relay App publish.`,
        defaultValue: false,
      },
      {
        type: "string",
        name: "relayAppPostFlairText",
        label: "Flair label to apply on new posts",
        helpText: `Enter the exact flair label to apply.`,
        defaultValue: `Mod Post`,
      },
      {
        name: "setFlairAfterCommenting",
        type: "boolean",
        label: "Enable auto-flair after commenting?",
        helpText: `When a moderator comments via Relay App, automatically update the post flair.`,
        defaultValue: false,
      },
      {
        type: "string",
        name: "relayAppCommentPostFlairText",
        label: "Flair label to apply after mod reply",
        helpText: `Enter the flair label to switch to after a mod replies (e.g., "Mods Replied").`,
        defaultValue: `Mods Replied`,
      },
    ],
  },

  // --- POST TEMPLATE #1 SETTINGS ---

  {
    type: "group",
    label: "Post Template 1",
    fields: [
      {
        name: "postTemplate1name",
        type: "string",
        label: "Template 1 name",
        helpText:
          "Internal name shown only in settings. Not visible to users or in posts",
        defaultValue: "First template",
      },
      {
        name: "postTemplate1title",
        type: "string",
        label: "Template 1 post title",
        helpText:
          "Prefilled title when using this template. Note: post titles can't be edited after publishing.",
      },
      {
        name: "postTemplate1body",
        type: "paragraph",
        label: `Template 1 post body`,
        helpText:
          "Prefilled body (Markdown supported). You can still edit before publishing.",
      },
{
    name: "postTemplate1Enabled",
    type: "boolean",
    label: "Enable scheduling for Template 1?",
    helpText: "Enable this to schedule posts using Template 1.",
    defaultValue: false,
  },
      {
        name: "postTemplate1Repeat",
        type: "boolean",
        label: "Repeat weekly?",
        helpText: "If off, this will only post once at the next scheduled time.",
        defaultValue: false,
      },
      {
        name: "postTemplate1Day",
        type: "select",
        label: "Day of the week",
        options: [
          { label: "Monday", value: "1" },
          { label: "Tuesday", value: "2" },
          { label: "Wednesday", value: "3" },
          { label: "Thursday", value: "4" },
          { label: "Friday", value: "5" },
          { label: "Saturday", value: "6" },
          { label: "Sunday", value: "0" },
        ],
        defaultValue: "1",
      },
      {
        name: "postTemplate1Hour",
        type: "number",
        label: "Hour (0-23) UTC",
        helpText: "Use 24-hour format (e.g., 13 = 1 PM, 17 = 5 PM). All schedules follow UTC time.",
        defaultValue: 0,
      },
      {
        name: "postTemplate1Minute",
        type: "number",
        label: "Minute (0-59) UTC",
        helpText: "Minute of the hour (0-59). All schedules follow UTC time.",
        defaultValue: 0,
      },
      {
        name: "postTemplate1Sticky",
        type: "boolean",
        label: "Sticky the scheduled post?",
        defaultValue: false,
      },
      {
        name: "postTemplate1Lock",
        type: "boolean",
        label: "Lock the scheduled post?",
        defaultValue: false,
      },
    ],
  },

  // --- POST TEMPLATE #2 SETTINGS ---

 